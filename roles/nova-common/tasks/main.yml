---
- name: install common nova packages
  yum: pkg={{ item }} state=present
  with_items:
    - openstack-nova-common
    - python-nova
    - python-novaclient
  tags: nova

- name: install rabbitmq driver
  yum: pkg=python-kombu state=present
  when: openstack_release == 'icehouse' or openstack_release == 'havana'
  when: use_rabbit and (openstack_release == 'icehouse' or openstack_release == 'havana')
  tags: nova

- name: deploy nova config files
  template: src={{ openstack_release }}/{{ item.src }}
            dest={{ item.dest }}
            mode=0640 owner=root group=nova
  with_items:
    - { src: nova.conf.j2, dest: /etc/nova/nova.conf }
    - { src: api-paste.ini.j2, dest: /etc/nova/api-paste.ini }
  when: openstack_release == 'icehouse' or openstack_release == 'havana'
  tags: nova

- name: Update api-paste.ini file for Juno
  command: openstack-config --verbose --set /etc/nova/api-paste.ini {{ item }}
  with_items:
    - "filter:authtoken auth_host {{ keystone_admin_vip | default('127.0.0.1') }}"
    - "filter:authtoken admin_tenant_name services"
    - "filter:authtoken admin_user compute"
    - "filter:authtoken admin_password {{ nova_pass }}"
  register: cmd
  changed_when: "'unchanged' not in cmd.stderr"
  tags: nova
  when: openstack_release == 'juno'
